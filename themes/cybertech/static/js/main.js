document.addEventListener('DOMContentLoaded', () => {
    // Select the wrapper div generated by Hugo
    const codeWrappers = document.querySelectorAll('.chroma, .highlight');

    codeWrappers.forEach(wrapper => {
        // Avoid duplicate buttons
        if (wrapper.querySelector('.copy-btn')) return;
        // If it's a 'pre' tag, skip it (we want the container or we work with pre if container is missing)
        if (wrapper.tagName === 'PRE' && wrapper.parentElement.classList.contains('chroma')) return;

        const button = document.createElement('button');
        button.className = 'copy-btn';
        button.innerText = 'Copy';
        button.ariaLabel = 'Copy code to clipboard';
        
        wrapper.style.position = 'relative'; 
        wrapper.appendChild(button);

        button.addEventListener('click', async () => {
            try {
                // Clone the code block to manipulate it without affecting the display
                const codeElement = wrapper.querySelector('code');
                let textToCopy = '';

                if (codeElement) {
                    const clone = codeElement.cloneNode(true);
                    
                    // Remove line numbers (.ln) from the clone
                    const lineNumbers = clone.querySelectorAll('.ln');
                    lineNumbers.forEach(ln => ln.remove());

                    textToCopy = clone.innerText;
                } else {
                    // Fallback if no code tag
                    textToCopy = wrapper.innerText; 
                }

                // Strip extra newlines that might result from removing spans
                // (Optional: depends on how innerText handles block formatting)
                
                await navigator.clipboard.writeText(textToCopy);
                button.innerText = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.innerText = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
                button.innerText = 'Error';
            }
        });
    });
});
